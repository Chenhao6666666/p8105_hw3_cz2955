p8105_hw3_cz2955
================
2025-10-06

## Problem 1

### Load data:

``` r
library(p8105.datasets)
data("instacart")
```

This dataset comprises partial information from Instacart order data,
containing users’ historical orders and itemised details of goods within
those orders. Each row in the data represents a specific item purchased
by a user during a particular order. Key variables include order_id,
product_id, add_to_cart_order, reordered, user_id, eval_set,
order_number, order_dow, order_hour_of_day, days_since_prior_order,
product_name, aisle_id, department_id, aisle, department. There are
total 1384617variables. The average reorder rate across all items is
0.599, indicating that a significant fraction of purchases are repeat
orders.

### (a):

``` r
length(unique(instacart$aisle))
```

    ## [1] 134

``` r
aisle_counts <- instacart%>%
  group_by(aisle)%>%
  summarise(num_orders = n())%>%
  arrange(desc(num_orders))

head(aisle_counts)
```

    ## # A tibble: 6 × 2
    ##   aisle                         num_orders
    ##   <chr>                              <int>
    ## 1 fresh vegetables                  150609
    ## 2 fresh fruits                      150473
    ## 3 packaged vegetables fruits         78493
    ## 4 yogurt                             55240
    ## 5 packaged cheese                    41699
    ## 6 water seltzer sparkling water      36617

### (b):

``` r
aisle_counts_large <- aisle_counts %>%
  filter(num_orders > 10000)
ggplot(aisle_counts_large, aes(x = reorder(aisle, -num_orders), y = num_orders)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Number of Items Ordered by Aisle",
       x = "Aisle",
       y = "Number of Items Ordered") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

![](p8105_hw3_cz2955_files/figure-gfm/unnamed-chunk-3-1.png)<!-- -->

### (c):

``` r
popular_items <- instacart %>%
  
  filter(aisle %in% c("baking ingredients", "dog food care", "packaged vegetables fruits")) %>% 
  group_by(aisle, product_name) %>% 
  summarise(num_orders = n()) %>% 
  arrange(aisle, desc(num_orders)) %>%
  slice_head(n = 3)
```

    ## `summarise()` has grouped output by 'aisle'. You can override using the
    ## `.groups` argument.

``` r
popular_items
```

    ## # A tibble: 9 × 3
    ## # Groups:   aisle [3]
    ##   aisle                      product_name                             num_orders
    ##   <chr>                      <chr>                                         <int>
    ## 1 baking ingredients         Light Brown Sugar                               499
    ## 2 baking ingredients         Pure Baking Soda                                387
    ## 3 baking ingredients         Cane Sugar                                      336
    ## 4 dog food care              Snack Sticks Chicken & Rice Recipe Dog …         30
    ## 5 dog food care              Organix Chicken & Brown Rice Recipe              28
    ## 6 dog food care              Small Dog Biscuits                               26
    ## 7 packaged vegetables fruits Organic Baby Spinach                           9784
    ## 8 packaged vegetables fruits Organic Raspberries                            5546
    ## 9 packaged vegetables fruits Organic Blueberries                            4966

### (d)

``` r
mean_order_hour <- instacart %>%
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) %>%
  group_by(product_name, order_dow) %>% 
  summarise(mean_hour = mean(order_hour_of_day, na.rm = TRUE)) %>% 
  pivot_wider(names_from = order_dow, values_from = mean_hour) %>% 
  arrange(product_name)
```

    ## `summarise()` has grouped output by 'product_name'. You can override using the
    ## `.groups` argument.

``` r
mean_order_hour
```

    ## # A tibble: 2 × 8
    ## # Groups:   product_name [2]
    ##   product_name       `0`   `1`   `2`   `3`   `4`   `5`   `6`
    ##   <chr>            <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
    ## 1 Coffee Ice Cream  13.8  14.3  15.4  15.3  15.2  12.3  13.8
    ## 2 Pink Lady Apples  13.4  11.4  11.7  14.2  11.6  12.8  11.9

## Problem 2

### Q1: There are 116 months between January 2015 and August 2024. How many ZIP codes are observed 116 times? How many are observed fewer than 10 times? Why are some ZIP codes are observed rarely and others observed in each month?

``` r
# Table1
Zip_Codes <- read_csv("Zip_Codes.csv") |>
  dplyr::select(County, ZipCode, Neighborhood) |>
  mutate(
    ZipCode = as.integer(ZipCode),
    County = as.character(County),
    Neighborhood = as.character(Neighborhood)
    )
```

    ## Rows: 322 Columns: 7
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (4): County, County Code, File Date, Neighborhood
    ## dbl (3): State FIPS, County FIPS, ZipCode
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
# Table2
Zip_NYC<-read_csv("Zip_NYC.csv")|>
  rename(ZipCode = RegionName,
         County = CountyName
         ) |>
  mutate(
    ZipCode = as.integer(ZipCode),
    County = str_replace(County, " County", "")
  )|>
  dplyr::select(ZipCode, County, starts_with("201"), starts_with("202"))|>
  pivot_longer(
    cols = -c(ZipCode, County),
    names_to = "Date",
    values_to = "RentPrice"
  )
```

    ## Rows: 149 Columns: 125
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr   (6): RegionType, StateName, State, City, Metro, CountyName
    ## dbl (119): RegionID, SizeRank, RegionName, 2015-01-31, 2015-02-28, 2015-03-3...
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
# Merge Table1, 2
z_together <- Zip_NYC |>
  left_join(Zip_Codes, by = c("ZipCode", "County"))

zip_counts <- z_together %>%
  drop_na(RentPrice) %>%
  group_by(ZipCode) %>%
  summarize(obs_count = n(), distinct_county = n_distinct(County)) %>%
  ungroup()

# Oberservation=116 times
n_116 <- zip_counts %>% 
  filter(obs_count == 116) %>% 
  nrow()

# Oberservation<10 times
n_lt10 <- zip_counts %>% 
  filter(obs_count < 10) %>% 
  nrow()
```

There are 48 ZIP codes observed 116 times and 26 ZIP codes are fewer
than 10 times. Certain postcodes yield monthly data due to high rental
activity and ample property listings within these areas; conversely,
some postcodes show infrequent observations owing to small market size,
infrequent listings, or incomplete data collection. Rental data is
observed monthly for certain postcodes, typically because these areas
feature active rental markets with ample supply and consistent data
collection coverage.

### Q2: Create a reader-friendly table showing the average rental price in each borough and year (not month). Comment on trends in this table.

``` r
# Table for average price
avg_rent <- z_together %>%
  mutate(Year = floor_date(as.Date(Date), unit = "year")) %>%  
  group_by(County, Year) %>%
  summarize(
    AvgRent = mean(RentPrice, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  mutate(Year = year(Year)) %>% 
  pivot_wider(names_from = County, values_from = AvgRent)

avg_rent
```

    ## # A tibble: 10 × 6
    ##     Year Bronx Kings `New York` Queens Richmond
    ##    <dbl> <dbl> <dbl>      <dbl>  <dbl>    <dbl>
    ##  1  2015 1760. 2493.      3022.  2215.     NaN 
    ##  2  2016 1520. 2520.      3039.  2272.     NaN 
    ##  3  2017 1544. 2546.      3134.  2263.     NaN 
    ##  4  2018 1639. 2547.      3184.  2292.     NaN 
    ##  5  2019 1706. 2631.      3310.  2388.     NaN 
    ##  6  2020 1811. 2555.      3107.  2316.    1978.
    ##  7  2021 1858. 2550.      3137.  2211.    2045.
    ##  8  2022 2054. 2868.      3778.  2406.    2147.
    ##  9  2023 2285. 3015.      3933.  2562.    2333.
    ## 10  2024 2497. 3127.      4078.  2694.    2536.

### Q3: Make a plot showing NYC Rental Prices within ZIP codes for all available years. Your plot should facilitate comparisons across boroughs. Comment on any significant elements of this plot.

``` r
avg_rent_long <- avg_rent %>%
  pivot_longer(
    cols = -Year,          
    names_to = "County",   
    values_to = "AvgRent"  
  )

p1 <- ggplot(avg_rent_long, aes(x = Year, y = AvgRent, color = County)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  labs(
    title = "NYC Rental Prices within ZIP codes for all available years",
    x = "Year",
    y = "Rental Prices ($)",
    color = "County"
  ) +
  theme_minimal() +
    scale_x_continuous(
    breaks = seq(min(avg_rent$Year, na.rm = TRUE),
                 max(avg_rent$Year, na.rm = TRUE),
                 by = 1) 
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

    ## Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
    ## ℹ Please use `linewidth` instead.
    ## This warning is displayed once every 8 hours.
    ## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was
    ## generated.

``` r
p1
```

    ## Warning: Removed 5 rows containing missing values or values outside the scale range
    ## (`geom_line()`).

    ## Warning: Removed 5 rows containing missing values or values outside the scale range
    ## (`geom_point()`).

![](p8105_hw3_cz2955_files/figure-gfm/unnamed-chunk-8-1.png)<!-- -->

The line chart shows the average rental prices across New York City
boroughs over time. A few key patterns stand out: 1.Rental prices
generally increased from 2015 to 2024 across all boroughs, reflecting
rising housing demand and inflationary pressures in the NYC market.
2.Around 2020–2021, a temporary decline or plateau appears, likely
corresponding to the COVID-19 pandemic’s impact on the rental market as
urban migration slowed and vacancy rates increased.

### Q4: Compute the average rental price within each ZIP code over each month in 2023. Make a reader-friendly plot showing the distribution of ZIP-code-level rental prices across boroughs; put differently, your plot should facilitate the comparison of the distribution of average rental prices across boroughs. Comment on this plot.

``` r
rent2023 <- z_together %>%
  mutate(Year = year(as.Date(Date)))%>%
  filter(Year == 2023) %>%
  group_by(County, ZipCode) %>%
  summarize(
    AvgRent2023 = mean(RentPrice, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  drop_na(AvgRent2023)

# Calculate the monthly average rent for each postcode in 2023

rent_2023 <- z_together %>%
  mutate(Year = year(as.Date(Date))) %>%
  filter(Year == 2023) %>%
  group_by(County, ZipCode) %>%
  summarize(
    AvgRent2023 = mean(RentPrice, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  drop_na(AvgRent2023)

# Plotting the distribution of rents across administrative districts
p2 <- ggplot(rent_2023, aes(x = County, y = AvgRent2023, fill = County)) +
  geom_violin(trim = FALSE, alpha = 0.7) +
  labs(
    title = "Distribution of ZIP-Code-Level Rental Prices Across NYC Boroughs (2023)",
    x = "Borough",
    y = "Average Monthly Rent ($)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 30, hjust = 1)
  )

p2
```

![](p8105_hw3_cz2955_files/figure-gfm/unnamed-chunk-9-1.png)<!-- -->

### Q5: Combine the two previous plots into a single graphic, and export this to a results folder in your repository.

``` r
combined_plot <- p1 / p2
combined_plot
```

    ## Warning: Removed 5 rows containing missing values or values outside the scale range
    ## (`geom_line()`).

    ## Warning: Removed 5 rows containing missing values or values outside the scale range
    ## (`geom_point()`).

![](p8105_hw3_cz2955_files/figure-gfm/unnamed-chunk-10-1.png)<!-- -->

``` r
ggsave("results/combined_plot.png", combined_plot, width = 12, height = 10, dpi = 300)
```

    ## Warning: Removed 5 rows containing missing values or values outside the scale range
    ## (`geom_line()`).
    ## Removed 5 rows containing missing values or values outside the scale range
    ## (`geom_point()`).

## Problem 3

### Q1: Load, tidy, merge, and otherwise organize the data sets. Your final dataset should include all originally observed variables; exclude participants less than 21 years of age, and those with missing demographic data; and encode data with reasonable variable classes (i.e. not numeric, and using factors with the ordering of tables and plots in mind).

``` r
# Demographic_data
demo_raw <- read_csv("demographic_data.csv") 
```

    ## New names:
    ## Rows: 254 Columns: 5
    ## ── Column specification
    ## ──────────────────────────────────────────────────────── Delimiter: "," chr
    ## (5): ...1, 1 = male, ...3, ...4, 1 = Less than high school
    ## ℹ Use `spec()` to retrieve the full column specification for this data. ℹ
    ## Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## • `` -> `...1`
    ## • `` -> `...3`
    ## • `` -> `...4`

``` r
colnames(demo_raw) <- demo_raw[4, ]     
demo <- demo_raw[-c(1:4), ] %>% 
  janitor::remove_empty(which = "cols") %>%
  mutate(
    SEQN = as.integer(SEQN),
    sex = recode(sex,
                 "1" = "Male",
                 "2" = "Female"),
    age = as.numeric(age),
    BMI = as.numeric(BMI),
    education = recode(education,
                       "1" = "Less than high school",
                       "2" = "High school equivalent",
                       "3" = "More than high school")
  )  %>% 
  filter(age >= 21) %>% 
  drop_na() %>% 
  clean_names() %>% 
  dplyr::select(-bmi)  

# Accelerometer_data
accel <- read_csv("accelerometer_data.csv") %>% 
  clean_names() %>% 
  pivot_longer(
    cols = starts_with("min"),  
    names_to = "minute",     
    values_to = "value"
  ) %>%
  mutate(
    minute = as.integer(str_remove(minute, "min"))
  )%>% 
  drop_na()
```

    ## Rows: 250 Columns: 1441
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (1441): SEQN, min1, min2, min3, min4, min5, min6, min7, min8, min9, min1...
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
# merge together
acc_together<-accel %>%
  left_join(demo, by = c("seqn" = "seqn"))%>% 
  drop_na()

acc_together
```

    ## # A tibble: 328,320 × 6
    ##     seqn minute value sex     age education             
    ##    <dbl>  <int> <dbl> <chr> <dbl> <chr>                 
    ##  1 62161      1 1.11  Male     22 High school equivalent
    ##  2 62161      2 3.12  Male     22 High school equivalent
    ##  3 62161      3 1.47  Male     22 High school equivalent
    ##  4 62161      4 0.938 Male     22 High school equivalent
    ##  5 62161      5 1.60  Male     22 High school equivalent
    ##  6 62161      6 0.145 Male     22 High school equivalent
    ##  7 62161      7 2.10  Male     22 High school equivalent
    ##  8 62161      8 0.509 Male     22 High school equivalent
    ##  9 62161      9 1.63  Male     22 High school equivalent
    ## 10 62161     10 1.20  Male     22 High school equivalent
    ## # ℹ 328,310 more rows

### Q2: Produce a reader-friendly table for the number of men and women in each education category, and create a visualization of the age distributions for men and women in each education category. Comment on these items.

``` r
gender_edu_table <- demo %>%
  group_by(education, sex) %>%
  summarize(count = n(), .groups = "drop") %>%
  pivot_wider(names_from = sex, values_from = count)
gender_edu_table
```

    ## # A tibble: 3 × 3
    ##   education              Female  Male
    ##   <chr>                   <int> <int>
    ## 1 High school equivalent     23    35
    ## 2 Less than high school      28    27
    ## 3 More than high school      59    56

``` r
# Visualization
gender_edu_long <- gender_edu_table %>%
  pivot_longer(cols = c(Female, Male), names_to = "Sex", values_to = "Count")
ggplot(gender_edu_long, aes(x = education, y = Count, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Count of Male and Female by Education",
       x = "Education Level",
       y = "Count") +
  theme_minimal()
```

![](p8105_hw3_cz2955_files/figure-gfm/unnamed-chunk-12-1.png)<!-- -->

Overall, the largest cohort comprises individuals with higher
educational attainment (‘More than high school’), indicating a
significant proportion of highly educated participants within the
sample. Males are more prevalent in the secondary education group (high
school equivalent), while females slightly outnumber males in the higher
education group. This may reflect gender disparities across different
educational levels within the sample.

### Q3: Traditional analyses of accelerometer data focus on the total activity over the day. Using your tidied dataset, aggregate across minutes to create a total activity variable for each participant. Plot these total activities (y-axis) against age (x-axis); your plot should compare men to women and have separate panels for each education level. Include a trend line or a smooth to illustrate differences. Comment on your plot.

``` r
total_activity <- acc_together %>% 
  group_by(seqn, sex, age, education) %>%  
  summarize(total_activity = sum(value, na.rm = TRUE), .groups = "drop")
# Plot
ggplot(total_activity, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.6) +           
  geom_smooth(method = "loess", se = FALSE) +  
  facet_wrap(~ education, scales = "free_y") + 
  labs(
    title = "Total Daily Activity vs Age by Sex and Education Level",
    x = "Age",
    y = "Total Activity",
    color = "Sex"
  ) +
  theme_minimal() +
  theme(strip.text = element_text(face = "bold"))
```

    ## `geom_smooth()` using formula = 'y ~ x'

![](p8105_hw3_cz2955_files/figure-gfm/unnamed-chunk-13-1.png)<!-- -->

Trend lines indicate that overall activity levels generally decline with
age, though the rate of decline may differ between men and women.

### Q4: Accelerometer data allows the inspection activity over the course of the day. Make a three-panel plot that shows the 24-hour activity time courses for each education level and use color to indicate sex. Describe in words any patterns or conclusions you can make based on this graph; including smooth trends may help identify differences.

``` r
hourly_activity <- acc_together %>%
  mutate(hour = floor(as.numeric(gsub("min", "", minute)) / 60)) %>% 
  group_by(sex, education, hour) %>%
  summarize(avg_activity = mean(value, na.rm = TRUE), .groups = "drop")

ggplot(hourly_activity, aes(x = hour, y = avg_activity, color = sex)) +
  geom_line(size = 1) +            
  geom_smooth(method = "loess", se = FALSE, linetype = "dashed") + 
  facet_wrap(~ education, ncol = 1) + 
  labs(
    title = "Average 24-hour Activity Curves by Education Level and Sex",
    x = "Hour of the Day",
    y = "Average Activity",
    color = "Sex"
  ) +
  theme_minimal() +
  theme(strip.text = element_text(face = "bold"))
```

    ## `geom_smooth()` using formula = 'y ~ x'

![](p8105_hw3_cz2955_files/figure-gfm/unnamed-chunk-14-1.png)<!-- -->

The trends observed in both males and females over a 24-hour period are
similar. Levels decline between 0 and 5 hours, rise between 5 and 10
hours, fluctuate evenly around 10 to 18 hours, and then decline again
between 18 and 24 hours.
